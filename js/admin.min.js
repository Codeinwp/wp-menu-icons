!function(a){"use strict";if(a.inputDependencies({selector:"select.hasdep",disable:!1}),a("#menu-icons-settings-tabs").on("click","a.mi-settings-nav-tab",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).blur(),d=a("#"+c.data("type"));c.parent().addClass("tabs").siblings().removeClass("tabs"),d.removeClass("tabs-panel-inactive").addClass("tabs-panel-active").show().siblings("div.tabs-panel").hide().addClass("tabs-panel-inactive").removeClass("tabs-panel-active")}).find("a.mi-settings-nav-tab").first().click(),!_.isUndefined(window.menuIcons)&&!_.isUndefined(window.menuIcons.iconTypes)){window.menuIcons=_.defaults({frame:"",currentItem:{},toggleSelect:function(b){var c=a(b.currentTarget),d=c.closest("div.menu-icons-wrap"),e=d.find("a._select"),f=d.find("a._remove");""!==c.val()?f.show():(e.text(e.data("text")),f.hide())},selectIcon:function(c){c.preventDefault(),c.stopPropagation();var d,e=a(this),f=b.view.settings.post.id=e.data("id");d={id:f,title:a("#edit-menu-item-title-"+f).val()},e.closest("div.menu-icons-wrap").find(":input").each(function(b,c){var e=a(c).data("key");d[e]=c.value}),window.menuIcons.currentItem=d,window.menuIcons.frame instanceof b.view.MediaFrame.menuIcons||(window.menuIcons.frame=new b.view.MediaFrame.menuIcons),window.menuIcons.frame.open()},removeIcon:function(b){b.preventDefault(),b.stopPropagation();var c=a(this).data("id");a("#menu-icons-"+c+"-type").val("").trigger("mi:update")}},window.menuIcons);var b=wp.media,c=b.model.Attachment;b.model.mi={},b.model.mi.MenuItems=Backbone.Collection.extend({props:new Backbone.Model({item:""}),model:Backbone.Model.extend({defaults:{type:"",group:"all",icon:""}})}),b.model.mi.MenuItems.Settings=Backbone.Collection.extend({model:Backbone.Model.extend({defaults:{id:"",label:"",value:"",type:"text"}})}),b.view.miSidebar=b.view.Sidebar.extend({initialize:function(){var a=new b.View({tagName:"h3",priority:-10}),c=new b.View({tagName:"p",className:"_info",priority:1e3});b.view.Sidebar.prototype.initialize.apply(this,arguments),a.$el.text(window.menuIcons.text.preview),this.set("title",a),c.$el.html(window.menuIcons.text.settingsInfo),this.set("info",c)}}),b.view.miSidebar.Settings=b.view.PriorityList.extend({className:"mi-settings attachment-info",prepare:function(){_.each(this.collection.map(this.createField,this),function(a){this.set(a.model.id,a)},this)},createField:function(a){var c=new b.view.miSidebar.Settings.Field({item:this.model,model:a,collection:this.collection});return c}}),b.view.miSidebar.Settings.Field=b.View.extend({tagName:"label",className:"setting",events:{"change :input":"_update"},initialize:function(){b.View.prototype.initialize.apply(this,arguments),this.template=b.template("menu-icons-settings-field-"+this.model.get("type")),this.model.on("change",this.render,this)},prepare:function(){return this.model.toJSON()},_update:function(b){var c=this.options.item,d=a(b.currentTarget),e=d.val(),f=a("#menu-icons-"+c.id+"-"+this.model.id+"._setting");this.model.set("value",e),c.set(this.model.id,e),f.val(e).trigger("mi:update")}}),b.view.miPreview=b.View.extend({tagName:"p",className:"mi-preview menu-item attachment-info",events:{"click a":"preventDefault"},initialize:function(){b.View.prototype.initialize.apply(this,arguments),this.model.on("change",this.render,this)},render:function(){var a=_.extend(this.model.toJSON(),this.options.data),c="menu-icons-"+a.type+"-preview-";return c+=a.hide_label?"hide_label":a.position,this.template=b.template(c),this.$el.html(this.template(a)),this},preventDefault:function(a){a.preventDefault()}}),b.view.miBrowser={createSidebar:function(){var a=this.options,c=a.selection,d=this.sidebar=new b.view.miSidebar({controller:this.controller,type:a.type});this.views.add(d),c.on("selection:single",this.createSingle,this),c.on("selection:unsingle",this.disposeSingle,this),c.single()&&this.createSingle()},createSingle:function(){this.createPreview()},createSettings:function(){var a=this.controller.miGetCurrentItem(),c=this.model.get("settings");c.length&&(_.each(c,function(b){b.value=a.get(b.id)}),this.sidebar.set("settings",new b.view.miSidebar.Settings({controller:this.controller,collection:new b.model.mi.MenuItems.Settings(c),model:a,type:this.options.type,priority:120})))}},b.view.miFont=b.View.extend({className:"attachments-browser mi-items-wrap",initialize:function(){this.createToolbar(),this.createLibrary(),this.createSidebar()},createLibrary:function(){this.items=new b.view.miFont.Library({controller:this.controller,collection:this.collection,selection:this.options.selection,type:this.options.type,data:this.options.data}),this.views.add(this.items)},createToolbar:function(){this.toolbar=new b.view.Toolbar({controller:this.controller}),this.views.add(this.toolbar),this.toolbar.set("filters",new b.view.miFont.Filters({controller:this.controller,model:this.collection.props,priority:-80}).render()),this.toolbar.set("search",new b.view.Search({controller:this.controller,model:this.collection.props,priority:60}).render())},createPreview:function(){var a=this.controller,c=a.miGetCurrentItem(),d=this.model.get("selection").single();this.createSettings(),this.sidebar.set("preview",new b.view.miPreview({controller:a,model:c,priority:80,data:{type:d.get("type"),icon:d.id}}))},disposeSingle:function(){var a=this.sidebar;a.unset("preview"),a.unset("settings")}}),_.extend(b.view.miFont.prototype,b.view.miBrowser),b.view.miFont.Library=b.View.extend({tagName:"ul",className:"attachments mi-items clearfix",initialize:function(){this._viewsByCid={},this.collection.on("reset",this.refresh,this),this.controller.on("open",this.scrollToSelected,this)},render:function(){return this.collection.each(function(a){this.views.add(this.renderItem(a),{at:this.collection.indexOf(a)})},this),this},renderItem:function(a){var c=new b.view.miFont.Icon({controller:this.controller,model:a,collection:this.collection,selection:this.options.selection,type:this.options.type,data:this.options.data});return this._viewsByCid[c.cid]=c},clearItems:function(){_.each(this._viewsByCid,function(a){delete this._viewsByCid[a.cid],a.remove()},this)},refresh:function(){this.clearItems(),this.render()},ready:function(){this.scrollToSelected()},scrollToSelected:function(){var a,b=this.options.selection.single();b&&(a=this.getView(b),a&&!this.isInView(a.$el)&&this.$el.scrollTop(a.$el.offset().top-this.$el.offset().top+this.$el.scrollTop()-parseInt(this.$el.css("paddingTop"),10)))},getView:function(a){return _.findWhere(this._viewsByCid,{model:a})},isInView:function(b){var c=a(window),d=c.scrollTop(),e=d+c.height(),f=b.offset().top,g=f+b.height();return e>=g&&f>=d}}),b.view.miFont.Filters=b.view.AttachmentFilters.extend({createFilters:function(){this.filters={all:{text:window.menuIcons.text.all,props:{group:"all"}}};var a=this.controller.state().get("data").groups;_.each(a,function(a,b){this.filters[b]={text:a,props:{group:b}}},this)},change:function(){var a=this.filters[this.el.value];a&&this.model.set("group",a.props.group)}}),b.view.miFont.Icon=b.view.Attachment.extend({className:"attachment mi-item",events:{"click .attachment-preview":"toggleSelectionHandler","click a":"preventDefault"},initialize:function(){this.template=b.template("menu-icons-"+this.options.type+"-item"),b.view.Attachment.prototype.initialize.apply(this,arguments)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.updateSelect(),this}}),b.controller.miFont=b.controller.State.extend({defaults:{id:"mi-font",menu:"default",toolbar:"mi-select",type:"",settings:["hide_label","position","font_size","vertical_align"]},initialize:function(){var c,d=this.get("data").items,e=this.get("library"),f=this.get("selection"),g=this.get("settings");e instanceof b.controller.miFont.Library||(e=new b.controller.miFont.Library(d),e.props.on("change",this.miResetLibrary,this),this.set("library",e)),f instanceof b.model.Selection||this.set("selection",new b.model.Selection(f,{multiple:!1})),c=_.filter(window.menuIcons.settingsFields,function(b){return-1!==a.inArray(b.id,g)}),this.set("settings",c)},activate:function(){this.frame.on("open",this.refresh,this),this.miUpdateSelection()},deactivate:function(){b.controller.State.prototype.deactivate.apply(this,arguments),this.frame.off("open",this.refresh,this)},refresh:function(){this.miResetFilter(),this.miUpdateSelection()},miGetContent:function(){return this.miResetFilter(),new b.view.miFont({controller:this.frame,model:this,collection:this.get("library"),selection:this.get("selection"),type:this.get("type")})},miResetLibrary:function(){var a=this.get("library"),b=a.props.get("group"),c=this.frame.miGetCurrentItem();c.set("group",b),a.reInitialize(),this.set("library",a),this.miUpdateSelection()},miResetFilter:function(){var a=this.get("library"),b=this.frame.miGetCurrentItem(),c=this.get("data").groups,d=b.get("group");_.isUndefined(c[d])&&(d="all"),a.props.set("group",d)},miUpdateSelection:function(){var a,b=this.get("selection"),c=this.get("type"),d=c+"-icon",e=this.frame.miGetCurrentItem(),f=e.get(d);c===e.get("type")&&f&&(a=this.get("library").findWhere({id:f})),b.reset(a?a:[])}}),b.controller.miFont.Library=Backbone.Collection.extend({props:new Backbone.Model({group:"all",search:""}),initialize:function(a){this.icons=new Backbone.Collection(a)},reInitialize:function(){var a=this,b=this.icons.toJSON(),c=this.props.toJSON();_.each(c,function(c,d){a.filters[d]&&(b=_.filter(b,a.filters[d],c))},this),this.reset(b)},filters:{group:function(a){var b=this;return"all"===b||a.group===b||""===a.group},search:function(a){var b,c=this;return b=""===c?!0:_.any(["id","label"],function(b){var c=a[b];return c&&-1!==c.search(this)},c)}}}),b.controller.miImage=b.controller.Library.extend({defaults:_.defaults({id:"browse",menu:"default",router:"browse",toolbar:"mi-select",filterable:"uploaded",settings:["hide_label","position","image_size","vertical_align"],syncSelection:!1},b.controller.Library.prototype.defaults),initialize:function(c){var d,e=this.get("selection"),f=this.get("settings");c.data.browserView||(c.data.browserView="miImage"),this.options=c,this.set("library",b.query(c.data.library)),this.routers={upload:{text:b.view.l10n.uploadFilesTitle,priority:20},browse:{text:b.view.l10n.mediaLibraryTitle,priority:40}},e instanceof b.model.Selection||this.set("selection",new b.model.Selection(e,{multiple:!1})),d=_.filter(window.menuIcons.settingsFields,function(b){return-1!==a.inArray(b.id,f)}),this.set("settings",d),b.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){b.controller.Library.prototype.activate.apply(this,arguments),this.frame.on("open",this.miUpdateSelection,this),this.get("library").observe(wp.Uploader.queue),this.miUpdateSelection()},deactivate:function(){b.controller.Library.prototype.deactivate.apply(this,arguments),this.get("library").unobserve(wp.Uploader.queue),this.frame.off("open",this.miUpdateSelection,this)},miUpdateSelection:function(){var a,b=this.get("selection"),d=this.get("type"),e=d+"-icon",f=this.frame.miGetCurrentItem(),g=f.get(e);d===f.get("type")&&g&&(a=c.get(g),this.dfd=a.fetch()),b.add(a?a:[])},miGetContent:function(a){var b="upload"===a?this.uploadContent():this.browseContent();return this.frame.$el.removeClass("hide-toolbar"),b},browseContent:function(){var a,c=this,d=c.get("type");return a={type:d,controller:c.frame,collection:c.get("library"),selection:c.get("selection"),model:c,sortable:c.get("sortable"),search:c.get("searchable"),filters:c.get("filterable"),display:c.get("displaySettings"),dragInfo:c.get("dragInfo"),idealColumnWidth:c.get("idealColumnWidth"),suggestedWidth:c.get("suggestedWidth"),suggestedHeight:c.get("suggestedHeight"),AttachmentView:c.get("AttachmentView")},"svg"===d&&(a.AttachmentView=b.view.Attachment.miSvg),new b.view.AttachmentsBrowser.miImage(a)},uploadContent:function(){return new b.view.UploaderInline({controller:this.frame})}}),b.controller.miSvg=b.controller.miImage.extend({defaults:_.defaults({settings:["hide_label","position","vertical_align","width"]},b.controller.miImage.prototype.defaults)}),b.view.AttachmentsBrowser.miImage=b.view.AttachmentsBrowser.extend({disposeSingle:function(){b.view.AttachmentsBrowser.prototype.disposeSingle.apply(this,arguments),this.sidebar.unset("preview"),this.sidebar.unset("settings")},createPreview:function(){var a,c,d,e=this,f=this.model;return f.dfd&&"pending"===f.dfd.state()?void f.dfd.done(function(){e.createPreview()}):(a=f.get("selection").single(),"image"!==a.get("type")?void f.get("selection").reset():a.get("uploading")?void a.on("change:uploading",e.createPreview,this):(c=this.controller,d=c.miGetCurrentItem(),this.createSettings(),void this.sidebar.set("preview",new b.view.miPreview.miImage({controller:c,settings:this.sidebar.get("settings"),model:d,priority:80,data:{type:f.get("type"),alt:a.get("alt"),sizes:a.get("sizes"),url:a.get("url")}}))))}}),_.extend(b.view.AttachmentsBrowser.miImage.prototype,b.view.miBrowser),b.view.Attachment.miSvg=b.view.Attachment.Library.extend({template:wp.template("menu-icons-svg-item")}),b.view.miPreview.miImage=b.view.miPreview.extend({render:function(){var a=this.options.model.get("image_size"),c=this.options.data.sizes,d=this.options.settings.get("image_size"),e=[];return _.isUndefined(c)||_.isUndefined(d)||(c.hasOwnProperty(a)||(a="full"),_.each(d.model.get("choices"),function(a){c.hasOwnProperty(a.value)&&e.push(a)}),this.options.data.url=c[a].url,d.model.set("choices",e),this.options.model.set("image_size",a,{silent:!0})),b.view.miPreview.prototype.render.apply(this,arguments)}}),b.view.MediaFrame.menuIcons=b.view.MediaFrame.extend({defaults:_.defaults({selection:[],multiple:!1,editing:!1,toolbar:"mi-select"},b.view.MediaFrame.prototype.defaults),initialize:function(){b.view.MediaFrame.prototype.initialize.apply(this,arguments),this.miMenuItems=new b.model.mi.MenuItems,this.createStates(),this.bindHandlers()},createStates:function(){var a,c=this.options;c.states||_.each(window.menuIcons.iconTypes,function(d,e){return b.controller.hasOwnProperty(d.data.controller)?(a=b.controller[d.data.controller],_.defaults(d,{content:d.id,selection:c.selection}),void this.states.add(new a(d))):void delete window.menuIcons.iconTypes[e]},this)},bindHandlers:function(){this.on("router:create:browse",this.createRouter,this),this.on("router:render:browse",this.browseRouter,this),this.on("content:render",this.miRenderContent,this),this.on("toolbar:create:mi-select",this.createToolbar,this),this.on("toolbar:render:mi-select",this.miSelectToolbar,this),this.on("open",this.miInitialize,this)},browseRouter:function(a){var b=this.state().routers;b&&a.set(b)},miRenderContent:function(){var a=this.state(),b=this.content.mode(),c=a.miGetContent(b);this.content.set(c)},miSelectToolbar:function(a){var b=this,c=b.state();a.set(c.id,{style:"primary",priority:80,text:window.menuIcons.text.select,requires:{selection:!0},click:function(){b.close(),b.miUpdateItemProps(),b.miUpdateItem()}})},miContentRender:function(){var a=this.state(),b=a.miGetContent();this.content.set(b)},miGetState:function(){var a,b=window.menuIcons.currentItem;return a=!_.isUndefined(b.type)&&""!==b.type&&window.menuIcons.iconTypes.hasOwnProperty(b.type)?b.type:window.menuIcons.typeNames[0],"mi-"+a},miGetCurrentItem:function(){return this.miMenuItems.get(window.menuIcons.currentItem.id)},miUpdateMenuItems:function(){var a=this.miGetCurrentItem();_.isUndefined(a)?this.miMenuItems.add(window.menuIcons.currentItem):a.set(window.menuIcons.currentItem),this.miMenuItems.props.set("item",window.menuIcons.currentItem.id)},miInitialize:function(){this.miUpdateMenuItems(),this.setState(this.miGetState())},miUpdateItemProps:function(){var a=this.state(),b=a.get("type"),c=a.get("selection"),d=c.single(),e=d?d.id:"",f=this.miGetCurrentItem();f.set("type",b),f.set(b+"-icon",e),f.set("icon",e)},miUpdateItem:function(){var c,d=this.miGetCurrentItem().toJSON(),e=d.id,f=this.state(),g=f.get("selection").single(),h=b.template("menu-icons-"+d.type+"-field"),i=g.toJSON();i._settings=d,delete d.id,delete d.title,_.each(d,function(b,d){c=a("#menu-icons-"+e+"-"+d).not("._setting"),c.length&&c.val(b).trigger("mi:update")}),a("#menu-icons-"+e+"-select").html(h(i))}}),a("body").on("click","div.menu-icons-wrap a._select",window.menuIcons.selectIcon).on("click","div.menu-icons-wrap a._remove",window.menuIcons.removeIcon).on("mi:update","div.menu-icons-wrap select._type",window.menuIcons.toggleSelect),a("div.menu-icons-wrap select._type").trigger("mi:update"),a("#menu-item-settings-save").on("click",function(b){var c=a(this).prop("disabled",!0),d=c.siblings("span.spinner");b.preventDefault(),d.css("display","inline-block"),a.ajax({type:"POST",url:window.menuIcons.ajaxUrls.update,data:a("#menu-icons-settings :input").serialize(),success:function(a){!0===a.success&&a.data.redirectUrl?window.location=a.data.redirectUrl:c.prop("disabled",!1)},always:function(){d.hide()}})}),a("#update-nav-menu svg").bind("click",function(){return a(this).closest("a").trigger("click"),!1})}}(jQuery);